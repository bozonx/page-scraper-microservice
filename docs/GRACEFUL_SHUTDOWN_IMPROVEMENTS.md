# Graceful Shutdown Improvements

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ë—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å graceful shutdown –≤ –ø—Ä–æ–µ–∫—Ç–µ.

## –°–ø–∏—Å–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

#### 1. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ shutdown**
- **–°–æ–∑–¥–∞–Ω** `ShutdownGuard` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–æ–≤—ã—Ö HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü—Ä–∏–º–µ–Ω–µ–Ω** –∫ `ScraperController` —á–µ—Ä–µ–∑ `@UseGuards(ShutdownGuard)`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: Keep-alive –∫–ª–∏–µ–Ω—Ç—ã –±–æ–ª—å—à–µ –Ω–µ –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è SIGTERM

**–§–∞–π–ª—ã:**
- `src/common/guards/shutdown.guard.ts` (–Ω–æ–≤—ã–π)
- `src/modules/scraper/scraper.controller.ts`

#### 2. **–û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á –≤ p-limit**
- **–î–æ–±–∞–≤–ª–µ–Ω** `OnApplicationShutdown` —Ö—É–∫ –≤ `ConcurrencyService`
- **–í—ã–∑—ã–≤–∞–µ—Ç—Å—è** `limit.clearQueue()` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–¥–∞—á
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–æ—Å–ª–µ shutdown

**–§–∞–π–ª—ã:**
- `src/modules/scraper/services/concurrency.service.ts`

#### 3. **–†–∞–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–º–µ–Ω—ã –≤ BatchService**
- **–î–æ–±–∞–≤–ª–µ–Ω–∞** –ø—Ä–æ–≤–µ—Ä–∫–∞ `cancelRequested` –≤ –Ω–∞—á–∞–ª–µ `processBatchItem()`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–¥–∞—á–∏, —É–∂–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –≤ –æ—á–µ—Ä–µ–¥—å, –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ shutdown

**–§–∞–π–ª—ã:**
- `src/modules/scraper/services/batch.service.ts`

---

### üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

#### 4. **–°–æ–∫—Ä–∞—â–µ–Ω webhook timeout –ø—Ä–∏ shutdown**
- **–ò–∑–º–µ–Ω–µ–Ω** timeout —Å 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è webhook –ø—Ä–∏ shutdown
- **–î–æ–±–∞–≤–ª–µ–Ω** `Promise.race()` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö webhook
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: Shutdown –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ webhook-–∑–∞–ø—Ä–æ—Å–∞—Ö

**–§–∞–π–ª—ã:**
- `src/modules/scraper/services/batch.service.ts`

#### 5. **–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è cleanup**
- **–î–æ–±–∞–≤–ª–µ–Ω** `OnApplicationShutdown` —Ö—É–∫ –≤ `CleanupService`
- **–û–∂–∏–¥–∞–µ—Ç—Å—è** –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ `runningPromise` –ø–µ—Ä–µ–¥ shutdown
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: Cleanup –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ

**–§–∞–π–ª—ã:**
- `src/modules/scraper/services/cleanup.service.ts`

#### 6. **–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü Playwright**
- **–î–æ–±–∞–≤–ª–µ–Ω–æ** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ `activePages` –≤ `BrowserService`
- **–û–∂–∏–¥–∞–µ—Ç—Å—è** –∑–∞–∫—Ä—ã—Ç–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (—Å —Ç–∞–π–º–∞—É—Ç–æ–º 5 —Å–µ–∫) –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –±—Ä–∞—É–∑–µ—Ä–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ù–µ—Ç race condition –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞

**–§–∞–π–ª—ã:**
- `src/modules/scraper/services/browser.service.ts`

---

### üü¢ –£–ª—É—á—à–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–æ)

#### 7. **–ú–µ—Ç—Ä–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**
- **–î–æ–±–∞–≤–ª–µ–Ω—ã** –º–µ—Ç–æ–¥—ã `incrementActiveRequests()` / `decrementActiveRequests()` –≤ `ShutdownService`
- **–ü—Ä–∏–º–µ–Ω–µ–Ω—ã** –≤ `ScraperController` –¥–ª—è –≤—Å–µ—Ö endpoint'–æ–≤
- **–õ–æ–≥–∏—Ä—É–µ—Ç—Å—è** –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ shutdown
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –õ—É—á—à–∞—è –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ shutdown

**–§–∞–π–ª—ã:**
- `src/common/services/shutdown.service.ts`
- `src/modules/scraper/scraper.controller.ts`

#### 8. **–£–ª—É—á—à–µ–Ω health check endpoint**
- **–î–æ–±–∞–≤–ª–µ–Ω—ã** –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ response –ø—Ä–∏ shutdown:
  - `activeRequests` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  - `timestamp` - –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: Load balancer –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª—É—á–∞—é—Ç –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–§–∞–π–ª—ã:**
- `src/modules/health/health.controller.ts`

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ graceful shutdown

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ SIGTERM/SIGINT** ‚Üí `main.ts:gracefulShutdown()`
2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ shutdown** ‚Üí `ShutdownService.markShuttingDown()`
3. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**:
   - Fastify –∑–∞–∫—Ä—ã–≤–∞–µ—Ç idle-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`forceCloseConnections: 'idle'`)
   - `ShutdownGuard` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 503 –¥–ª—è –Ω–æ–≤—ã—Ö HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
   - Health check –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 503 —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
4. **–û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π**:
   - `ConcurrencyService` –æ—á–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å `p-limit`
   - `BatchService` –ø–æ–º–µ—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∂–æ–±—ã –∫–∞–∫ `cancelRequested`
5. **–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á** (–¥–æ 30 —Å–µ–∫):
   - –ê–∫—Ç–∏–≤–Ω—ã–µ scraping-–∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
   - Batch-–¥–∂–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç webhook (—Å —Ç–∞–π–º–∞—É—Ç–æ–º 5 —Å–µ–∫)
   - Cleanup –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
   - Playwright –∂–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (–¥–æ 5 —Å–µ–∫)
6. **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** ‚Üí `app.close()`
7. **–¢–∞–π–º–∞—É—Ç** (30 —Å–µ–∫) ‚Üí `process.exit(1)` –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

### –¢–∞–π–º–∞—É—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–∞–π–º–∞—É—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|---------|----------|
| **–û–±—â–∏–π shutdown** | 30 —Å–µ–∫ | `APP_CLOSE_TIMEOUT_MS` |
| **Webhook –ø—Ä–∏ shutdown** | 5 —Å–µ–∫ | –°–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π timeout |
| **Playwright —Å—Ç—Ä–∞–Ω–∏—Ü—ã** | 5 —Å–µ–∫ | –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü |
| **–û–±—ã—á–Ω—ã–π webhook** | 30 —Å–µ–∫ | `DEFAULT_WEBHOOK_TIMEOUT_SECS` |
| **Scraping –∑–∞–¥–∞—á–∞** | 60 —Å–µ–∫ | `DEFAULT_TASK_TIMEOUT_SECS` |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `health.controller.spec.ts` —Å mock –¥–ª—è `ShutdownService`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è shutdown —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ health check
- ‚úÖ –í—Å–µ 81 unit —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥—è—Ç

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è E2E —Ç–µ—Å—Ç–æ–≤
–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ shutdown (503 –æ—Ç Guard)
2. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –¥–æ —Ç–∞–π–º–∞—É—Ç–∞
3. Webhook –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
4. Health check –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –ø—Ä–∏ shutdown

```
[ShutdownService] Graceful shutdown initiated. Active requests: 3
[ConcurrencyService] Clearing pending tasks queue...
[BatchService] Waiting for 2 webhooks (max 5000ms)...
[BrowserService] Waiting for 1 active pages to close...
[CleanupService] Waiting for cleanup to complete...
[Bootstrap] Graceful shutdown completed successfully
```

### Health check –ø—Ä–∏ shutdown

```bash
GET /api/v1/health
# Response: 503 Service Unavailable
{
  "status": "shutting_down",
  "activeRequests": 3,
  "timestamp": "2025-12-20T15:30:00.000Z"
}
```

---

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ API –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **AbortSignal –¥–ª—è Playwright** - –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å signal –≤ `page.goto()` –¥–ª—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
2. **–ú–µ—Ç—Ä–∏–∫–∏ Prometheus** - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `activeRequests` –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç—Ä–∏–∫–∏
3. **E2E —Ç–µ—Å—Ç—ã shutdown** - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ graceful shutdown
4. **Graceful shutdown –¥–ª—è webhook** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã webhook –ø—Ä–∏ shutdown

# ะััะตั: ะะฝะฐะปะธะท ัะฐะฑะพัั Playwright ะฒ ะฟัะพะตะบัะต Page Scraper Microservice

**ะะฐัะฐ:** 2025-12-21  
**ะะตััะธั ะฟัะพะตะบัะฐ:** 1.1.0  
**ะะตััะธั Playwright:** 1.57.0

---

## ะัะฐัะบะพะต ัะตะทัะผะต

ะ ะฟัะพะตะบัะต ะธัะฟะพะปัะทัะตััั **ะพะดะธะฝ ะฟะพััะพัะฝะฝะพ ะทะฐะฟััะตะฝะฝัะน ะธะฝััะฐะฝั ะฑัะฐัะทะตัะฐ Playwright** (Chromium), ะบะพัะพััะน ัะพะทะดะฐะตััั ะฟัะธ ััะฐััะต ะฟัะธะปะพะถะตะฝะธั ะธ ะพััะฐะตััั ะฐะบัะธะฒะฝัะผ ะดะพ ะตะณะพ ะทะฐะฒะตััะตะฝะธั. ะัะต ะบะพะฝะบััะตะฝัะฝัะต ะทะฐะฟัะพัั ะพะฑัะฐะฑะฐััะฒะฐัััั ัะตัะตะท ััะพั ะตะดะธะฝััะฒะตะฝะฝัะน ะธะฝััะฐะฝั ะฑัะฐัะทะตัะฐ, ะฝะพ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ **ะธะทะพะปะธัะพะฒะฐะฝะฝัั ะบะพะฝัะตะบััะพะฒ ะธ ัััะฐะฝะธั** ะดะปั ะบะฐะถะดะพะณะพ ะทะฐะฟัะพัะฐ.

**ะะปััะตะฒัะต ะผะพะผะตะฝัั:**
- โ **ะะดะธะฝ ะธะฝััะฐะฝั ะฑัะฐัะทะตัะฐ** (persistent browser)
- โ **ะะฝะพะถะตััะฒะตะฝะฝัะต ะธะทะพะปะธัะพะฒะฐะฝะฝัะต ะบะพะฝัะตะบััั** (BrowserContext) ะดะปั ะบะฐะถะดะพะณะพ ะทะฐะฟัะพัะฐ
- โ **ะะปะพะฑะฐะปัะฝะพะต ะพะณัะฐะฝะธัะตะฝะธะต ะบะพะฝะบััะตะฝัะฝะพััะธ** ัะตัะตะท `ConcurrencyService` (ะฟะพ ัะผะพะปัะฐะฝะธั 3 ะพะดะฝะพะฒัะตะผะตะฝะฝัั ะทะฐะดะฐัะธ)
- โ **ะญััะตะบัะธะฒะฝะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟะฐะผััะธ** ะทะฐ ััะตั ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฑัะฐัะทะตัะฐ
- โ๏ธ **ะะพัะตะฝัะธะฐะปัะฝะฐั ะฟัะพะฑะปะตะผะฐ:** ััะตัะบะฐ ะฟะฐะผััะธ ะฟัะธ ะดะพะปะณะพะน ัะฐะฑะพัะต ะฑัะฐัะทะตัะฐ

---

## 1. ะััะธัะตะบัััะฐ ัะฐะฑะพัั ั Playwright

### 1.1 ะะฝะธัะธะฐะปะธะทะฐัะธั ะฑัะฐัะทะตัะฐ

**ะคะฐะนะป:** `src/modules/scraper/services/browser.service.ts`

```typescript
@Injectable()
export class BrowserService implements OnModuleInit, OnModuleDestroy {
    private browser: Browser | null = null
    private activePages = 0
    
    async onModuleInit() {
        this.logger.info('Launching persistent Playwright browser...')
        this.browser = await chromium.launch({
            headless: scraperConfig.playwrightHeadless,
            args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-gpu',
            ],
        })
        this.logger.info('Browser launched successfully')
    }
}
```

**ะะพะณะดะฐ ะทะฐะฟััะบะฐะตััั:**
- ะัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ NestJS ะผะพะดัะปั (`OnModuleInit`)
- ะัะพะธััะพะดะธั **ะพะดะธะฝ ัะฐะท** ะฟัะธ ััะฐััะต ะฟัะธะปะพะถะตะฝะธั
- ะัะฐัะทะตั ะพััะฐะตััั ะฐะบัะธะฒะฝัะผ ะดะพ ะทะฐะฒะตััะตะฝะธั ัะฐะฑะพัั ะฟัะธะปะพะถะตะฝะธั

**ะะพะฝัะธะณััะฐัะธั ะฑัะฐัะทะตัะฐ:**
- Headless ัะตะถะธะผ (ะฟะพ ัะผะพะปัะฐะฝะธั `true`, ะฝะฐัััะฐะธะฒะฐะตััั ัะตัะตะท `PLAYWRIGHT_HEADLESS`)
- ะคะปะฐะณะธ ะฑะตะทะพะฟะฐัะฝะพััะธ ะดะปั ัะฐะฑะพัั ะฒ Docker/ะบะพะฝัะตะนะฝะตัะฐั
- ะัะบะปััะตะฝะธะต GPU ะดะปั ัะบะพะฝะพะผะธะธ ัะตััััะพะฒ

### 1.2 ะะฐะบัััะธะต ะฑัะฐัะทะตัะฐ

```typescript
async onModuleDestroy() {
    if (this.browser) {
        // ะะถะธะดะฐะฝะธะต ะทะฐะบัััะธั ะฐะบัะธะฒะฝัั ัััะฐะฝะธั (ัะฐะนะผะฐัั 5 ัะตะบัะฝะด)
        if (this.activePages > 0) {
            this.logger.info(`Waiting for ${this.activePages} active pages to close...`)
            // ะะถะธะดะฐะฝะธะต ั ัะฐะนะผะฐััะพะผ
        }
        await this.browser.close()
        this.browser = null
    }
}
```

**Graceful shutdown:**
- ะะถะธะดะฐะตั ะทะฐะฒะตััะตะฝะธั ะฐะบัะธะฒะฝัั ัััะฐะฝะธั (ะดะพ 5 ัะตะบัะฝะด)
- ะัะธะฝัะดะธัะตะปัะฝะพ ะทะฐะบััะฒะฐะตั ะฑัะฐัะทะตั ะตัะปะธ ัััะฐะฝะธัั ะฝะต ะทะฐะบััะปะธัั
- ะะฐัะฐะฝัะธััะตั ะบะพััะตะบัะฝะพะต ะพัะฒะพะฑะพะถะดะตะฝะธะต ัะตััััะพะฒ

---

## 2. ะะพะดะตะปั ะบะพะฝะบััะตะฝัะฝะพััะธ

### 2.1 ะะปะพะฑะฐะปัะฝะพะต ะพะณัะฐะฝะธัะตะฝะธะต ะบะพะฝะบััะตะฝัะฝะพััะธ

**ะคะฐะนะป:** `src/modules/scraper/services/concurrency.service.ts`

```typescript
@Injectable()
export class ConcurrencyService {
    private readonly limit: LimitFunction
    
    constructor() {
        const max = Math.max(1, configuredMax) // ะะพ ัะผะพะปัะฐะฝะธั 3
        this.limit = pLimit(max)
    }
    
    run<T>(fn: () => Promise<T>, signal?: AbortSignal): Promise<T> {
        return this.limit(async () => {
            if (signal?.aborted) throw new Error('Request aborted')
            return fn()
        })
    }
}
```

**ะะฐะบ ัะฐะฑะพัะฐะตั:**
- ะัะฟะพะปัะทัะตั ะฑะธะฑะปะธะพัะตะบั `p-limit` ะดะปั ะพะณัะฐะฝะธัะตะฝะธั ะบะพะฝะบััะตะฝัะฝะพััะธ
- **ะะปะพะฑะฐะปัะฝัะน ะปะธะผะธั** ะฟัะธะผะตะฝัะตััั ะบะพ ะฒัะตะผ ะทะฐะฟัะพัะฐะผ (single page + batch)
- ะะพะฝัะธะณััะธััะตััั ัะตัะตะท `MAX_CONCURRENCY` (ะฟะพ ัะผะพะปัะฐะฝะธั 3)
- ะัะปะธ ะปะธะผะธั ะดะพััะธะณะฝัั, ะฝะพะฒัะต ะทะฐะดะฐัะธ **ััะฐะฒัััั ะฒ ะพัะตัะตะดั** ะธ ะถะดัั ะพัะฒะพะฑะพะถะดะตะฝะธั ัะปะพัะฐ

**ะัะธะผะตั:**
```
MAX_CONCURRENCY=3
ะะฐะฟัะพั 1: ะฒัะฟะพะปะฝัะตััั โ
ะะฐะฟัะพั 2: ะฒัะฟะพะปะฝัะตััั โ
ะะฐะฟัะพั 3: ะฒัะฟะพะปะฝัะตััั โ
ะะฐะฟัะพั 4: ะฒ ะพัะตัะตะดะธ โณ
ะะฐะฟัะพั 5: ะฒ ะพัะตัะตะดะธ โณ
```

### 2.2 ะะทะพะปััะธั ะทะฐะฟัะพัะพะฒ ัะตัะตะท ะบะพะฝัะตะบััั

**ะคะฐะนะป:** `src/modules/scraper/services/browser.service.ts`

```typescript
async withPage<T>(
    callback: (page: Page) => Promise<T>,
    fingerprint?: any,
    signal?: AbortSignal
): Promise<T> {
    this.activePages++
    
    // ะกะพะทะดะฐะฝะธะต ะะะะะะ ะธะทะพะปะธัะพะฒะฐะฝะฝะพะณะพ ะบะพะฝัะตะบััะฐ ะดะปั ะบะฐะถะดะพะณะพ ะทะฐะฟัะพัะฐ
    context = await this.browser.newContext({
        viewport: fingerprint?.fingerprint?.screen ? {...} : undefined,
        userAgent: fingerprint?.fingerprint?.navigator?.userAgent,
        locale: fingerprint?.fingerprint?.navigator?.language,
    })
    
    // ะะฝัะตะบัะธั fingerprint ะดะปั ะพะฑัะพะดะฐ anti-bot
    if (fingerprint && fingerprint.fingerprint) {
        await this.fingerprintInjector.attachFingerprintToPlaywright(context, fingerprint)
    }
    
    // ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะน ัััะฐะฝะธัั ะฒ ะบะพะฝัะตะบััะต
    page = await context.newPage()
    
    try {
        return await callback(page)
    } finally {
        this.activePages--
        await page.close()
        await context.close()
    }
}
```

**ะะปััะตะฒัะต ะผะพะผะตะฝัั:**
- **ะะฐะถะดัะน ะทะฐะฟัะพั ะฟะพะปััะฐะตั ัะฒะพะน BrowserContext** (ะธะทะพะปะธัะพะฒะฐะฝะฝะฐั ัะตััะธั)
- **ะะฐะถะดัะน ะบะพะฝัะตะบัั ะธะผะตะตั ัะฒะพั Page** (ะฒะบะปะฐะดะบะฐ ะฑัะฐัะทะตัะฐ)
- **ะะพะปะฝะฐั ะธะทะพะปััะธั:** cookies, localStorage, session storage ะฝะต ะฟะตัะตัะตะบะฐัััั
- **ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ:** context ะธ page ะทะฐะบััะฒะฐัััั ะฟะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั
- **ะกัะตััะธะบ ะฐะบัะธะฒะฝัั ัััะฐะฝะธั** (`activePages`) ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ

### 2.3 ะะพัะพะบ ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะฟัะพัะฐ

```
1. HTTP Request โ ScraperController
2. ScraperService.scrapePage()
3. ConcurrencyService.run() โ ะัะพะฒะตัะบะฐ ะปะธะผะธัะฐ ะบะพะฝะบััะตะฝัะฝะพััะธ
   โโ ะัะปะธ ัะปะพั ัะฒะพะฑะพะดะตะฝ โ ะฟัะพะดะพะปะถะธัั
   โโ ะัะปะธ ะปะธะผะธั ะดะพััะธะณะฝัั โ ะฒ ะพัะตัะตะดั
4. BrowserService.withPage()
   โโ browser.newContext() โ ะะพะฒัะน ะธะทะพะปะธัะพะฒะฐะฝะฝัะน ะบะพะฝัะตะบัั
   โโ context.newPage() โ ะะพะฒะฐั ัััะฐะฝะธัะฐ
   โโ ะะฝัะตะบัะธั fingerprint
   โโ page.goto(url) โ ะะฐะฒะธะณะฐัะธั
   โโ page.content() โ ะะพะปััะตะฝะธะต HTML
   โโ Cleanup: page.close(), context.close()
5. ะะฑัะฐะฑะพัะบะฐ ัะตะทัะปััะฐัะฐ
6. HTTP Response
```

---

## 3. ะะพััะตะฑะปะตะฝะธะต ะฟะฐะผััะธ

### 3.1 ะะพะผะฟะพะฝะตะฝัั ะฟะพััะตะฑะปะตะฝะธั ะฟะฐะผััะธ

**1. ะะฐะทะพะฒัะน ะฟัะพัะตัั ะฑัะฐัะทะตัะฐ Chromium:**
- **~50-150 MB** ะฒ headless ัะตะถะธะผะต (ะฑะตะท ัััะฐะฝะธั)
- ะะดะธะฝ ะธะฝััะฐะฝั ะฝะฐ ะฒัั ะฟัะธะปะพะถะตะฝะธะต

**2. BrowserContext (ะฝะฐ ะบะฐะถะดัะน ะทะฐะฟัะพั):**
- **~10-30 MB** ะฝะฐ ะบะพะฝัะตะบัั
- ะกะพะทะดะฐะตััั ะดะปั ะบะฐะถะดะพะณะพ ะบะพะฝะบััะตะฝัะฝะพะณะพ ะทะฐะฟัะพัะฐ
- ะะฒัะพะผะฐัะธัะตัะบะธ ัะดะฐะปัะตััั ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั

**3. Page (ะฝะฐ ะบะฐะถะดัะน ะทะฐะฟัะพั):**
- **~20-100 MB** ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะปะพะถะฝะพััะธ ัััะฐะฝะธัั
- ะะบะปััะฐะตั DOM, JavaScript runtime, rendered content
- ะะปะพะบะธัะพะฒะบะฐ ัะตััััะพะฒ ัะฝะธะถะฐะตั ะฟะพััะตะฑะปะตะฝะธะต:
  - `blockTrackers=true`: ัะบะพะฝะพะผะธั ~10-30%
  - `blockHeavyResources=true`: ัะบะพะฝะพะผะธั ~30-50%

**4. Batch jobs (ะฒ ะฟะฐะผััะธ):**
- ะะตะทัะปััะฐัั ััะฐะฝัััั ะฒ `BatchService.jobs` (Map)
- **~1-10 KB** ะฝะฐ ัะตะทัะปััะฐั ะพะดะฝะพะณะพ URL
- TTL: 60 ะผะธะฝัั (ะฝะฐัััะฐะธะฒะฐะตััั ัะตัะตะท `DATA_LIFETIME_MINS`)
- ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ะบะฐะถะดัะต 10 ะผะธะฝัั

### 3.2 ะัะตะฝะบะฐ ะฟะพััะตะฑะปะตะฝะธั ะฟะฐะผััะธ

**ะกัะตะฝะฐัะธะน 1: ะะธะทะบะฐั ะฝะฐะณััะทะบะฐ (1-2 ะบะพะฝะบััะตะฝัะฝัั ะทะฐะฟัะพัะฐ)**
```
ะัะฐัะทะตั:           100 MB
Context ร 2:        40 MB
Page ร 2:          100 MB
Batch results:      10 MB
Node.js runtime:   100 MB
โโโโโโโโโโโโโโโโโโโโโโโโโ
ะะขะะะ:            ~350 MB
```

**ะกัะตะฝะฐัะธะน 2: ะกัะตะดะฝัั ะฝะฐะณััะทะบะฐ (3 ะบะพะฝะบััะตะฝัะฝัั ะทะฐะฟัะพัะฐ, MAX_CONCURRENCY=3)**
```
ะัะฐัะทะตั:           100 MB
Context ร 3:        60 MB
Page ร 3:          150 MB
Batch results:      50 MB
Node.js runtime:   100 MB
โโโโโโโโโโโโโโโโโโโโโโโโโ
ะะขะะะ:            ~460 MB
```

**ะกัะตะฝะฐัะธะน 3: ะััะพะบะฐั ะฝะฐะณััะทะบะฐ (10 ะบะพะฝะบััะตะฝัะฝัั ะทะฐะฟัะพัะพะฒ, MAX_CONCURRENCY=10)**
```
ะัะฐัะทะตั:           120 MB
Context ร 10:      200 MB
Page ร 10:         500 MB
Batch results:     200 MB
Node.js runtime:   150 MB
โโโโโโโโโโโโโโโโโโโโโโโโโ
ะะขะะะ:           ~1170 MB (1.14 GB)
```

### 3.3 ะะฟัะธะผะธะทะฐัะธั ะฟะฐะผััะธ

**ะขะตะบััะธะต ะผะตัะฐะฝะธะทะผั:**
1. โ **ะะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะฑัะฐัะทะตัะฐ** (ะพะดะธะฝ ะธะฝััะฐะฝั)
2. โ **ะะฒัะพะผะฐัะธัะตัะบะพะต ะทะฐะบัััะธะต ะบะพะฝัะตะบััะพะฒ** (finally ะฑะปะพะบ)
3. โ **ะะปะพะบะธัะพะฒะบะฐ ัะตััััะพะฒ** (trackers, images, videos)
4. โ **TTL ะดะปั batch ัะตะทัะปััะฐัะพะฒ** (60 ะผะธะฝัั)
5. โ **ะะปะพะฑะฐะปัะฝัะน ะปะธะผะธั ะบะพะฝะบััะตะฝัะฝะพััะธ** (ะทะฐัะธัะฐ ะพั ะฟะตัะตะณััะทะบะธ)

**ะะตะบะพะผะตะฝะดะฐัะธะธ ะดะปั ัะฝะธะถะตะฝะธั ะฟะพััะตะฑะปะตะฝะธั:**
1. ๐ง ะฃะผะตะฝััะธัั `MAX_CONCURRENCY` (ะฝะฐะฟัะธะผะตั, ะดะพ 2)
2. ๐ง ะะบะปััะธัั `blockTrackers=true` ะธ `blockHeavyResources=true` ะฟะพ ัะผะพะปัะฐะฝะธั
3. ๐ง ะฃะผะตะฝััะธัั `DATA_LIFETIME_MINS` (ะฝะฐะฟัะธะผะตั, ะดะพ 30 ะผะธะฝัั)
4. ๐ง ะะพะฑะฐะฒะธัั ะฟะตัะธะพะดะธัะตัะบะธะน ะฟะตัะตะทะฐะฟััะบ ะฑัะฐัะทะตัะฐ (ะบะฐะถะดัะต N ัะฐัะพะฒ)

---

## 4. ะะพะฝะบััะตะฝัะฝะพััั ะฒ Batch Jobs

### 4.1 ะะฑัะฐะฑะพัะบะฐ batch ะทะฐะฟัะพัะพะฒ

**ะคะฐะนะป:** `src/modules/scraper/services/batch.service.ts`

```typescript
private async processBatchJob(jobId: string): Promise<void> {
    const items = [...job.request.items]
    
    // ะะฑัะฐะฑะพัะบะฐ ัะปะตะผะตะฝัะพะฒ ะะะกะะะะะะะขะะะฌะะ
    for (let current = 0; current < items.length; current++) {
        if (job.cancelRequested) break
        
        // ะะฐะดะตัะถะบะฐ ะผะตะถะดั ะทะฐะฟัะพัะฐะผะธ (ะบัะพะผะต ะฟะตัะฒะพะณะพ)
        if (current > 0) {
            const delay = this.calculateDelay(minDelayMs, maxDelayMs, jitter)
            await this.sleep(delay)
        }
        
        const item = items[current]
        await this.processBatchItem(jobId, item, current)
    }
}

private async processBatchItem(jobId: string, item: BatchItemDto): Promise<void> {
    // ะัะทะพะฒ ScraperService, ะบะพัะพััะน ะธัะฟะพะปัะทัะตั ConcurrencyService
    const result = await this.scraperService.scrapePage(scraperRequest)
    // ...
}
```

**ะะฐะถะฝะพ:**
- Batch ัะปะตะผะตะฝัั ะพะฑัะฐะฑะฐััะฒะฐัััั **ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ** ะฒะฝัััะธ ะพะดะฝะพะณะพ batch job
- ะะพ **ะณะปะพะฑะฐะปัะฝัะน ะปะธะผะธั ะบะพะฝะบััะตะฝัะฝะพััะธ** ะฒัะต ัะฐะฒะฝะพ ะฟัะธะผะตะฝัะตััั ัะตัะตะท `ConcurrencyService`
- ะัะปะธ ะทะฐะฟััะตะฝะพ ะฝะตัะบะพะปัะบะพ batch jobs ะพะดะฝะพะฒัะตะผะตะฝะฝะพ, ะพะฝะธ **ะบะพะฝะบััะธัััั** ะทะฐ ัะปะพัั

**ะัะธะผะตั:**
```
Batch Job 1: [URL1, URL2, URL3] โ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ
Batch Job 2: [URL4, URL5, URL6] โ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ

ะะพ ะณะปะพะฑะฐะปัะฝะพ:
ะกะปะพั 1: URL1 (Job 1) โ
ะกะปะพั 2: URL4 (Job 2) โ
ะกะปะพั 3: URL2 (Job 1) โณ ะถะดะตั ะทะฐะฒะตััะตะฝะธั URL1
```

### 4.2 ะะฐะดะตัะถะบะธ ะธ jitter

```typescript
private calculateDelay(minMs: number, maxMs: number, jitter: boolean): number {
    let delay = Math.random() * (maxMs - minMs) + minMs
    
    if (jitter) {
        // ะะพะฑะฐะฒะปะตะฝะธะต ยฑ20% jitter
        const jitterAmount = delay * 0.2
        delay += (Math.random() - 0.5) * jitterAmount
    }
    
    return Math.round(delay)
}
```

**ะฆะตะปั:**
- ะะทะฑะตะถะฐัั rate limiting ะฝะฐ ัะตะปะตะฒัั ัะฐะนัะฐั
- ะะผะธัะฐัะธั ัะตะปะพะฒะตัะตัะบะพะณะพ ะฟะพะฒะตะดะตะฝะธั
- ะะพ ัะผะพะปัะฐะฝะธั: 1500-4000ms ั jitter

---

## 5. ะกัะฐะฒะฝะตะฝะธะต ั Cheerio (Extractor mode)

### 5.1 Extractor mode (ะฑะตะท Playwright)

**ะคะฐะนะป:** `src/modules/scraper/services/scraper.service.ts`

```typescript
private async scrapeWithExtractor(request: ScraperRequestDto): Promise<any> {
    // ะัะฟะพะปัะทัะตั @extractus/article-extractor
    // ะัะพััะพะน HTTP ะทะฐะฟัะพั ะฑะตะท ะฑัะฐัะทะตัะฐ
    const fp = this.fingerprintService.generateFingerprint(request.fingerprint)
    const headers = {
        'Accept-Language': fp.headers?.['Accept-Language'],
        'User-Agent': fp.headers?.['User-Agent']
    }
    
    return await this.articleExtractor.extract(request.url, { headers })
}
```

**ะัะปะธัะธั ะพั Playwright:**

| ะฅะฐัะฐะบัะตัะธััะธะบะฐ | Extractor (Cheerio-like) | Playwright |
|----------------|--------------------------|------------|
| **ะัะฐัะทะตั** | ะะต ะธัะฟะพะปัะทัะตััั | Chromium (persistent) |
| **JavaScript** | ะะต ะฒัะฟะพะปะฝัะตััั | ะะพะปะฝะฐั ะฟะพะดะดะตัะถะบะฐ |
| **ะะฐะผััั** | ~5-20 MB ะฝะฐ ะทะฐะฟัะพั | ~50-150 MB ะฝะฐ ะทะฐะฟัะพั |
| **ะกะบะพัะพััั** | ะััััะพ (100-500ms) | ะะตะดะปะตะฝะฝะพ (2-10s) |
| **ะะพะฝะบััะตะฝัะฝะพััั** | ะงะตัะตะท `ConcurrencyService` | ะงะตัะตะท `ConcurrencyService` |
| **Anti-bot** | ะะณัะฐะฝะธัะตะฝะฝะฐั (headers) | ะะพะปะฝะฐั (fingerprints) |

**ะะฑัะตะต:**
- โ ะะฑะฐ ัะตะถะธะผะฐ ะธัะฟะพะปัะทััั **ะพะดะธะฝ ะธ ัะพั ะถะต `ConcurrencyService`**
- โ ะะปะพะฑะฐะปัะฝัะน ะปะธะผะธั `MAX_CONCURRENCY` ะฟัะธะผะตะฝัะตััั ะบ ะพะฑะพะธะผ
- โ ะัะตัะตะดั ะทะฐะดะฐั ะพะฑัะฐั

---

## 6. ะะพัะตะฝัะธะฐะปัะฝัะต ะฟัะพะฑะปะตะผั ะธ ัะธัะบะธ

### 6.1 ะฃัะตัะบะฐ ะฟะฐะผััะธ ะฟัะธ ะดะพะปะณะพะน ัะฐะฑะพัะต

**ะัะพะฑะปะตะผะฐ:**
- Chromium ะผะพะถะตั ะฝะฐะบะฐะฟะปะธะฒะฐัั ะฟะฐะผััั ะฟัะธ ะดะปะธัะตะปัะฝะพะน ัะฐะฑะพัะต
- ะะตั ะผะตัะฐะฝะธะทะผะฐ ะฟะตัะธะพะดะธัะตัะบะพะณะพ ะฟะตัะตะทะฐะฟััะบะฐ ะฑัะฐัะทะตัะฐ

**ะะตัะตะฝะธะต:**
```typescript
// ะะพะฑะฐะฒะธัั ะฒ BrowserService
private browserRestartIntervalHours = 24

async onModuleInit() {
    await this.launchBrowser()
    
    // ะะตัะธะพะดะธัะตัะบะธะน ะฟะตัะตะทะฐะฟััะบ
    setInterval(async () => {
        this.logger.info('Restarting browser for memory cleanup...')
        await this.restartBrowser()
    }, this.browserRestartIntervalHours * 60 * 60 * 1000)
}

private async restartBrowser() {
    if (this.browser) {
        await this.browser.close()
    }
    await this.launchBrowser()
}
```

### 6.2 ะะปะพะบะธัะพะฒะบะฐ ะฟัะธ ะฒััะพะบะพะน ะฝะฐะณััะทะบะต

**ะัะพะฑะปะตะผะฐ:**
- ะัะธ `MAX_CONCURRENCY=3` ะธ ะฑะพะปััะพะผ ะบะพะปะธัะตััะฒะต ะทะฐะฟัะพัะพะฒ ะพะฑัะฐะทัะตััั ะพัะตัะตะดั
- ะะตั ัะฐะนะผะฐััะฐ ะฝะฐ ะพะถะธะดะฐะฝะธะต ะฒ ะพัะตัะตะดะธ

**ะะตัะตะฝะธะต:**
```typescript
// ะ ConcurrencyService ะดะพะฑะฐะฒะธัั ัะฐะนะผะฐัั
run<T>(fn: () => Promise<T>, signal?: AbortSignal, timeoutMs = 60000): Promise<T> {
    return Promise.race([
        this.limit(async () => fn()),
        new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Queue timeout')), timeoutMs)
        )
    ])
}
```

### 6.3 ะััััััะฒะธะต ะผะพะฝะธัะพัะธะฝะณะฐ

**ะัะพะฑะปะตะผะฐ:**
- ะะตั ะผะตััะธะบ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฟะฐะผััะธ ะฑัะฐัะทะตัะฐ
- ะะตั ะผะตััะธะบ ะฟะพ ัะฐะทะผะตัั ะพัะตัะตะดะธ

**ะะตัะตะฝะธะต:**
```typescript
// ะะพะฑะฐะฒะธัั ะผะตััะธะบะธ
getMetrics() {
    return {
        activePages: this.activePages,
        queueSize: this.limit.pendingCount,
        activeCount: this.limit.activeCount,
        browserMemory: await this.getBrowserMemoryUsage()
    }
}
```

---

## 7. ะัะฒะพะดั ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ

### 7.1 ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ

โ **ะัะตะธะผััะตััะฒะฐ:**
1. ะญััะตะบัะธะฒะฝะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตััััะพะฒ (ะพะดะธะฝ ะฑัะฐัะทะตั)
2. ะะทะพะปััะธั ะทะฐะฟัะพัะพะฒ ัะตัะตะท ะบะพะฝัะตะบััั
3. ะะปะพะฑะฐะปัะฝัะน ะบะพะฝััะพะปั ะบะพะฝะบััะตะฝัะฝะพััะธ
4. Graceful shutdown
5. ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ัะตััััะพะฒ

โ๏ธ **ะะตะดะพััะฐัะบะธ:**
1. ะะตั ะฟะตัะธะพะดะธัะตัะบะพะณะพ ะฟะตัะตะทะฐะฟััะบะฐ ะฑัะฐัะทะตัะฐ
2. ะะตั ัะฐะนะผะฐััะฐ ะฝะฐ ะพะถะธะดะฐะฝะธะต ะฒ ะพัะตัะตะดะธ
3. ะะตั ะผะพะฝะธัะพัะธะฝะณะฐ ะฟะฐะผััะธ
4. Batch jobs ะพะฑัะฐะฑะฐััะฒะฐัััั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ (ะผะพะถะตั ะฑััั ะผะตะดะปะตะฝะฝะพ)

### 7.2 ะะตะบะพะผะตะฝะดะฐัะธะธ

**ะะปั production:**
1. ๐ง ะะพะฑะฐะฒะธัั ะฟะตัะธะพะดะธัะตัะบะธะน ะฟะตัะตะทะฐะฟััะบ ะฑัะฐัะทะตัะฐ (ะบะฐะถะดัะต 12-24 ัะฐัะฐ)
2. ๐ง ะะพะฑะฐะฒะธัั endpoint ะดะปั ะผะตััะธะบ (`GET /metrics`)
3. ๐ง ะะฐัััะพะธัั ะผะพะฝะธัะพัะธะฝะณ ะฟะฐะผััะธ (Prometheus + Grafana)
4. ๐ง ะะพะฑะฐะฒะธัั health check ั ะฟัะพะฒะตัะบะพะน ะฑัะฐัะทะตัะฐ
5. ๐ง ะะฐััะผะพััะตัั ัะฒะตะปะธัะตะฝะธะต `MAX_CONCURRENCY` ะฝะฐ ะผะพัะฝัั ัะตัะฒะตัะฐั

**ะะปั ะพะฟัะธะผะธะทะฐัะธะธ ะฟะฐะผััะธ:**
1. ๐ง ะะบะปััะธัั `blockTrackers` ะธ `blockHeavyResources` ะฟะพ ัะผะพะปัะฐะฝะธั
2. ๐ง ะฃะผะตะฝััะธัั `DATA_LIFETIME_MINS` ะดะพ 30 ะผะธะฝัั
3. ๐ง ะะพะฑะฐะฒะธัั ะปะธะผะธั ะฝะฐ ัะฐะทะผะตั batch job (ะฝะฐะฟัะธะผะตั, max 100 URLs)

**ะะปั ัะปัััะตะฝะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ:**
1. ๐ง ะะฐััะผะพััะตัั ะฟะฐัะฐะปะปะตะปัะฝัั ะพะฑัะฐะฑะพัะบั batch items (ั ััะตัะพะผ delays)
2. ๐ง ะะพะฑะฐะฒะธัั ะบะตัะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ ะดะปั ะฟะพะฒัะพััััะธััั URL
3. ๐ง ะัะฟะพะปัะทะพะฒะฐัั connection pooling ะดะปั HTTP ะทะฐะฟัะพัะพะฒ

### 7.3 ะัะพะณะพะฒะฐั ััะตะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  NestJS Application                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ         ConcurrencyService (p-limit)           โ    โ
โ  โ         MAX_CONCURRENCY = 3 (default)          โ    โ
โ  โ                                                 โ    โ
โ  โ  โโโโโโโโ  โโโโโโโโ  โโโโโโโโ  โโโโโโโโ      โ    โ
โ  โ  โSlot 1โ  โSlot 2โ  โSlot 3โ  โQueue โ      โ    โ
โ  โ  โโโโฌโโโโ  โโโโฌโโโโ  โโโโฌโโโโ  โโโโฌโโโโ      โ    โ
โ  โโโโโโโผโโโโโโโโโผโโโโโโโโโผโโโโโโโโโผโโโโโโโโโโโโโโโ    โ
โ        โ        โ        โ        โ                    โ
โ        โผ        โผ        โผ        โผ                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ          BrowserService                      โ      โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ      โ
โ  โ  โ  Chromium Browser (persistent)     โ     โ      โ
โ  โ  โ  Memory: ~100-150 MB               โ     โ      โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ      โ
โ  โ                                              โ      โ
โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โ      โ
โ  โ  โContext 1 โ  โContext 2 โ  โContext 3 โ  โ      โ
โ  โ  โ  Page 1  โ  โ  Page 2  โ  โ  Page 3  โ  โ      โ
โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 8. ะัะฒะตัั ะฝะฐ ะฒะพะฟัะพัั

### Q1: ะะฐะฟััะบะฐะตััั ะฝะตัะบะพะปัะบะพ ะธะฝััะฐะฝัะพะฒ Playwright ะธะปะธ ะพะดะธะฝ?

**ะัะฒะตั:** ะะฐะฟััะบะฐะตััั **ะพะดะธะฝ ะธะฝััะฐะฝั ะฑัะฐัะทะตัะฐ Playwright** (Chromium), ะบะพัะพััะน ัะพะทะดะฐะตััั ะฟัะธ ััะฐััะต ะฟัะธะปะพะถะตะฝะธั ะธ ัะฐะฑะพัะฐะตั ะฟะพััะพัะฝะฝะพ ะดะพ ะตะณะพ ะทะฐะฒะตััะตะฝะธั.

### Q2: ะะฐะบ ััััะพะตะฝะฐ ะบะพะฝะบััะตะฝัะฝะพััั ะทะฐะฟัะพัะพะฒ?

**ะัะฒะตั:** 
1. ะัะต ะทะฐะฟัะพัั (single + batch) ะฟัะพัะพะดัั ัะตัะตะท `ConcurrencyService` ั ะณะปะพะฑะฐะปัะฝัะผ ะปะธะผะธัะพะผ (ะฟะพ ัะผะพะปัะฐะฝะธั 3)
2. ะะฐะถะดัะน ะทะฐะฟัะพั ะฟะพะปััะฐะตั **ัะฒะพะน ะธะทะพะปะธัะพะฒะฐะฝะฝัะน BrowserContext ะธ Page**
3. ะัะธ ะดะพััะธะถะตะฝะธะธ ะปะธะผะธัะฐ ะฝะพะฒัะต ะทะฐะฟัะพัั **ััะฐะฒัััั ะฒ ะพัะตัะตะดั** (p-limit)
4. ะะพัะปะต ะทะฐะฒะตััะตะฝะธั ะทะฐะฟัะพัะฐ ะบะพะฝัะตะบัั ะธ ัััะฐะฝะธัะฐ **ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะบััะฒะฐัััั**

### Q3: ะะฐะบ ััะพ ะฒะปะธัะตั ะฝะฐ ะฟะพััะตะฑะปะตะฝะธะต ะฟะฐะผััะธ?

**ะัะฒะตั:**
- **ะะฐะทะพะฒะพะต ะฟะพััะตะฑะปะตะฝะธะต:** ~350-460 MB ะฟัะธ 1-3 ะบะพะฝะบััะตะฝัะฝัั ะทะฐะฟัะพัะฐั
- **ะััะพะบะฐั ะฝะฐะณััะทะบะฐ:** ~1-1.5 GB ะฟัะธ 10 ะบะพะฝะบััะตะฝัะฝัั ะทะฐะฟัะพัะฐั
- **ะะฟัะธะผะธะทะฐัะธั:** ะฑะปะพะบะธัะพะฒะบะฐ ัะตััััะพะฒ ัะฝะธะถะฐะตั ะฟะพััะตะฑะปะตะฝะธะต ะฝะฐ 30-50%
- **ะะธัะบ:** ะฒะพะทะผะพะถะฝะฐ ััะตัะบะฐ ะฟะฐะผััะธ ะฟัะธ ะดะพะปะณะพะน ัะฐะฑะพัะต (ะฝะตั ะฟะตัะธะพะดะธัะตัะบะพะณะพ ะฟะตัะตะทะฐะฟััะบะฐ)

---

**ะะพะฝะตั ะพััะตัะฐ**

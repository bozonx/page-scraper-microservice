# Отчет о консистентности значений по умолчанию и лимитов

## Дата проверки: 2025-12-06

## Проверенные источники
1. **README.md** - документация API
2. **src/config/scraper.config.ts** - конфигурация сервиса
3. **src/modules/scraper/dto/** - DTO с валидацией
4. **n8n-nodes-bozonx-page-scraper-microservice/nodes/PageScraper/PageScraper.node.ts** - N8N нода
5. **.env.production.example** - пример конфигурации

---

## ✅ Консистентные параметры

### 1. Task Timeout (taskTimeoutSecs)
- **Значение по умолчанию:** `60` секунд
- **Минимум:** `1` секунда
- **Максимум:** не ограничено (только Min(1) в DTO)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 124) | `60` | ✅ |
| README.md (строка 205) | `60` | ✅ |
| scraper.config.ts (строка 158) | `60` | ✅ |
| .env.production.example (строка 19) | `60` | ✅ |
| N8N node (строка 130) | `60` | ✅ |
| N8N node (строка 326) | `60` | ✅ |
| DTO Min validation | `1` | ✅ |

### 2. Batch Min Delay (minDelayMs)
- **Значение по умолчанию:** `1500` мс
- **Минимум:** `500` мс
- **Максимум:** `3600000` мс (1 час)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 173) | `1500` | ✅ |
| README.md (строка 308) | `1000` (пример) | ⚠️ Пример |
| scraper.config.ts (строка 177) | `1500` | ✅ |
| .env.production.example (строка 53) | `1500` | ✅ |
| N8N node (строка 368) | `1500` | ✅ |
| DTO Min/Max validation | `500-3600000` | ✅ |

### 3. Batch Max Delay (maxDelayMs)
- **Значение по умолчанию:** `4000` мс
- **Минимум:** `1000` мс
- **Максимум:** `3600000` мс (1 час)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 174) | `4000` | ✅ |
| README.md (строка 309) | `3000` (пример) | ⚠️ Пример |
| scraper.config.ts (строка 178) | `4000` | ✅ |
| .env.production.example (строка 56) | `4000` | ✅ |
| N8N node (строка 376) | `4000` | ✅ |
| DTO Min/Max validation | `1000-3600000` | ✅ |

### 4. Webhook Timeout (timeoutSecs)
- **Значение по умолчанию:** `30` секунд
- **Минимум:** `1` секунда
- **Максимум:** `600` секунд (10 минут)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 182) | `30` | ✅ |
| README.md (строка 315) | `30` (пример) | ✅ |
| scraper.config.ts (строка 184) | `30` | ✅ |
| .env.production.example (строка 66) | `30` | ✅ |
| N8N node (строка 459) | `30` | ✅ |
| DTO Min/Max validation | `1-600` | ✅ |

### 5. Webhook Backoff (backoffMs)
- **Значение по умолчанию:** `1000` мс
- **Минимум:** `100` мс
- **Максимум:** `600000` мс (10 минут)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 183) | `1000` | ✅ |
| README.md (строка 316) | `1000` (пример) | ✅ |
| scraper.config.ts (строка 185) | `1000` | ✅ |
| .env.production.example (строка 69) | `1000` | ✅ |
| N8N node (строка 444) | `1000` | ✅ |
| DTO Min/Max validation | `100-600000` | ✅ |

### 6. Webhook Max Attempts (maxAttempts)
- **Значение по умолчанию:** `3`
- **Минимум:** `1`
- **Максимум:** `100`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 184) | `3` | ✅ |
| README.md (строка 317) | `3` (пример) | ✅ |
| README.md (строка 502) | `5` (пример) | ⚠️ Пример |
| scraper.config.ts (строка 186) | `3` | ✅ |
| .env.production.example (строка 72) | `3` | ✅ |
| N8N node (строка 452) | `3` | ✅ |
| DTO Min/Max validation | `1-100` | ✅ |

### 7. Max Concurrency
- **Значение по умолчанию:** `3`
- **Минимум:** `1`
- **Максимум:** не ограничено (только Min(1) в config)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 117) | `3` | ✅ |
| scraper.config.ts (строка 179) | `3` | ✅ |
| .env.production.example (строка 12) | `3` | ✅ |

### 8. Data Lifetime (dataLifetimeMins)
- **Значение по умолчанию:** `60` минут
- **Минимум:** `1` минута
- **Максимум:** `44640` минут (31 день)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 175) | `60` | ✅ |
| scraper.config.ts (строка 180) | `60` | ✅ |
| .env.production.example (строка 59) | `60` | ✅ |
| Config Min/Max validation | `1-44640` | ✅ |

### 9. Cleanup Interval (cleanupIntervalMins)
- **Значение по умолчанию:** `10` минут
- **Минимум:** `1` минута
- **Максимум:** `10080` минут (7 дней)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 176) | `10` | ✅ |
| scraper.config.ts (строка 181) | `10` | ✅ |
| .env.production.example (строка 62) | `10` | ✅ |
| Config Min/Max validation | `1-10080` | ✅ |

### 10. Playwright Navigation Timeout
- **Значение по умолчанию:** `30` секунд
- **Минимум:** `1` секунда
- **Максимум:** не ограничено (только Min(1) в config)

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 165) | `30` | ✅ |
| scraper.config.ts (строка 166) | `30` | ✅ |
| .env.production.example (строка 43) | `30` | ✅ |

### 11. Fingerprint Settings

#### Generate
- **Значение по умолчанию:** `true`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 131) | `true` | ✅ |
| README.md (строка 209) | `true` (пример) | ✅ |
| scraper.config.ts (строка 173) | `true` | ✅ |
| .env.production.example (строка 33) | `true` | ✅ |
| N8N node (строка 151) | `true` | ✅ |

#### User Agent
- **Значение по умолчанию:** `auto`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 132) | `auto` | ✅ |
| README.md (строка 210) | `auto` (пример) | ✅ |
| scraper.config.ts (строка 159) | `auto` | ✅ |
| .env.production.example (строка 23) | `auto` | ✅ |
| N8N node (строка 158) | `auto` | ✅ |

#### Locale
- **Значение по умолчанию:** `en-US`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 133) | `en-US` | ✅ |
| README.md (строка 211) | `en-US` (пример) | ✅ |
| scraper.config.ts (строка 160) | `en-US` | ✅ |
| .env.production.example (строка 26) | `en-US` | ✅ |
| N8N node (строка 166) | `auto` | ❌ НЕСООТВЕТСТВИЕ |

#### Timezone ID
- **Значение по умолчанию:** `UTC`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 134) | `UTC` | ✅ |
| README.md (строка 212) | `UTC` (пример) | ✅ |
| scraper.config.ts (строка 161) | `UTC` | ✅ |
| .env.production.example (строка 30) | `UTC` | ✅ |
| N8N node (строка 174) | `UTC` | ✅ |

#### Rotate On Anti-Bot
- **Значение по умолчанию:** `true`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 135) | `true` | ✅ |
| README.md (строка 213) | `true` (пример) | ✅ |
| scraper.config.ts (строка 174) | `true` | ✅ |
| .env.production.example (строка 36) | `true` | ✅ |
| N8N node (строка 182) | `true` | ✅ |

#### Browsers
- **Значение по умолчанию:** `["chrome", "firefox"]`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 214) | `["chrome", "firefox"]` (пример) | ✅ |
| N8N node (строка 189) | `'chrome,firefox'` | ✅ |

#### Operating Systems
- **Значение по умолчанию:** `["windows", "macos", "linux"]`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 215) | `["windows", "macos", "linux"]` (пример) | ✅ |
| N8N node (строка 197) | `'windows,macos,linux'` | ✅ |

#### Devices
- **Значение по умолчанию:** `["desktop", "mobile"]`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 216) | `["desktop", "mobile"]` (пример) | ✅ |
| N8N node (строка 205) | `'desktop,mobile'` | ✅ |

#### Locales
- **Значение по умолчанию:** `["en-US"]`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 217) | `["en-US"]` (пример) | ✅ |
| N8N node (строка 213) | `'en-US'` | ✅ |

### 12. Block Trackers
- **Значение по умолчанию:** `true`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 166) | `true` | ✅ |
| README.md (строка 206) | `true` (пример) | ✅ |
| scraper.config.ts (строка 169) | `true` | ✅ |
| .env.production.example (строка 46) | `true` | ✅ |
| N8N node (строка 137) | `true` | ✅ |

### 13. Block Heavy Resources
- **Значение по умолчанию:** `true`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 167) | `true` | ✅ |
| README.md (строка 207) | `false` (пример) | ⚠️ Пример |
| scraper.config.ts (строка 170) | `true` | ✅ |
| .env.production.example (строка 49) | `true` | ✅ |
| N8N node (строка 144) | `true` | ✅ |

### 14. Default Mode
- **Значение по умолчанию:** `extractor`

| Источник | Значение | Статус |
|----------|----------|--------|
| README.md (строка 123) | `extractor` | ✅ |
| README.md (строка 203) | `extractor` (комментарий) | ✅ |
| scraper.config.ts (строка 157) | `extractor` | ✅ |
| .env.production.example (строка 16) | `extractor` | ✅ |
| N8N node (строка 99) | `extractor` | ✅ |

---

## ❌ Найденные несоответствия

### 1. Fingerprint Locale в N8N ноде
**Проблема:** В N8N ноде значение по умолчанию для `fingerprintLocale` установлено как `'auto'`, в то время как везде используется `'en-US'`.

**Местоположение:** 
- `n8n-nodes-bozonx-page-scraper-microservice/nodes/PageScraper/PageScraper.node.ts`, строка 166

**Ожидаемое значение:** `'en-US'`
**Фактическое значение:** `'auto'`

**Влияние:** Пользователи N8N ноды будут получать другое поведение по умолчанию, чем при прямом использовании API.

---

## ⚠️ Замечания

### 1. Примеры в документации
В README.md некоторые примеры используют значения, отличные от defaults:
- Строка 207: `blockHeavyResources: false` (default: `true`)
- Строка 308: `minDelayMs: 1000` (default: `1500`)
- Строка 309: `maxDelayMs: 3000` (default: `4000`)
- Строка 502: `maxAttempts: 5` (default: `3`)

**Статус:** Это нормально для примеров, показывающих различные варианты использования.

### 2. Отсутствие валидации максимума для некоторых параметров
Некоторые параметры имеют только минимальную валидацию:
- `taskTimeoutSecs` - только `@Min(1)`, нет максимума
- `globalMaxConcurrency` - только `@Min(1)`, нет максимума
- `playwrightNavigationTimeoutSecs` - только `@Min(1)`, нет максимума

**Статус:** Это может быть преднамеренным дизайном, но стоит рассмотреть добавление разумных максимумов.

---

## Рекомендации

### Критичные
1. ✅ **Исправить значение по умолчанию для `fingerprintLocale` в N8N ноде** с `'auto'` на `'en-US'`

### Желательные
1. Рассмотреть добавление максимальных значений для:
   - `taskTimeoutSecs` (например, 600 секунд / 10 минут)
   - `globalMaxConcurrency` (например, 100)
   - `playwrightNavigationTimeoutSecs` (например, 300 секунд / 5 минут)

2. Добавить в документацию явное указание, что примеры могут использовать значения, отличные от defaults

---

## Итоговая оценка

**Общая консистентность:** 98% ✅

**Критичные проблемы:** 1
**Некритичные замечания:** 2

**Вывод:** Проект имеет очень хорошую консистентность значений по умолчанию и лимитов. Найдено только одно критичное несоответствие в N8N ноде, которое легко исправить.
